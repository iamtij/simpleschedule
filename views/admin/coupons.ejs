<%- include('../partials/admin-header') %>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Coupon Management</h1>
        <button onclick="openCreateModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            Create New Coupon
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <form id="filterForm" class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
                <label class="block text-sm font-medium text-gray-700 mb-1">Code</label>
                <input type="text" name="code" value="<%= filters.code || '' %>" 
                    class="w-full px-3 py-2 border rounded-lg" placeholder="Search by code">
            </div>
            <div class="w-48">
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select name="status" class="w-full px-3 py-2 border rounded-lg">
                    <option value="">All</option>
                    <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>Active</option>
                    <option value="inactive" <%= filters.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
                </select>
            </div>
            <div class="w-48">
                <label class="block text-sm font-medium text-gray-700 mb-1">Show Expired</label>
                <select name="showExpired" class="w-full px-3 py-2 border rounded-lg">
                    <option value="true" <%= filters.showExpired ? 'selected' : '' %>>Yes</option>
                    <option value="false" <%= !filters.showExpired ? 'selected' : '' %>>No</option>
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit" class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200">
                    Apply Filters
                </button>
            </div>
        </form>
    </div>

    <!-- Coupons Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uses</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expires</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <% coupons.forEach(coupon => { %>
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900"><%= coupon.code %></div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900"><%= coupon.description || '-' %></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900"><%= coupon.current_uses || 0 %>/<%= coupon.max_uses %></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                <%= coupon.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                                <%= coupon.status %>
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                <%= coupon.expires_at ? new Date(coupon.expires_at).toLocaleDateString() : 'Never' %>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-left text-sm font-medium">
                            <button onclick="openEditModal('<%= JSON.stringify(coupon) %>')" 
                                class="text-blue-600 hover:text-blue-900 mr-4">
                                <i class="fas fa-edit"></i>
                            </button>
                            <a href="/admin/coupons/<%= coupon.id %>/usage"
                                class="text-green-600 hover:text-green-900 mr-4">
                                <i class="fas fa-chart-line"></i>
                            </a>
                            <button onclick="showDeleteConfirmation('<%= coupon.id %>')"
                                class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="couponModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="modalTitle">Create New Coupon</h3>
            <form id="couponForm" class="space-y-4">
                <input type="hidden" id="couponId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Code</label>
                    <input type="text" id="code" required
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="description" rows="2"
                        class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Maximum Uses</label>
                    <input type="number" id="maxUses" required min="1"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                    <input type="datetime-local" id="expiresAt"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="status" class="w-full px-3 py-2 border rounded-lg">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeCouponModal()"
                        class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">
                        Cancel
                    </button>
                    <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Usage Modal -->
<div id="usageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Coupon Usage Details</h3>
            <div id="usageDetails" class="space-y-4">
                <!-- Usage details will be populated here -->
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeUsageModal()"
                    class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-[480px] shadow-lg rounded-2xl bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-center">
                <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                </div>
            </div>
            <div class="mt-4 text-center">
                <h3 class="text-xl font-semibold text-gray-900">Delete Coupon</h3>
                <div class="mt-3">
                    <p class="text-base text-gray-600">
                        Are you sure you want to delete this coupon? This action cannot be undone.
                    </p>
                </div>
                <div class="mt-6 flex justify-center space-x-3">
                    <button onclick="closeDeleteModal()" 
                        class="w-32 bg-gray-100 text-gray-700 px-4 py-3 rounded-lg text-base font-medium hover:bg-gray-200">
                        Cancel
                    </button>
                    <button id="confirmDeleteButton"
                        class="w-32 bg-red-600 text-white px-4 py-3 rounded-lg text-base font-medium hover:bg-red-700">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentCoupon = null;
let couponToDelete = null;

function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'Create New Coupon';
    document.getElementById('couponId').value = '';
    document.getElementById('couponForm').reset();
    document.getElementById('couponModal').classList.remove('hidden');
}

function openEditModal(couponStr) {
    const coupon = JSON.parse(couponStr.replace(/&quot;/g, '"'));
    currentCoupon = coupon;
    document.getElementById('modalTitle').textContent = 'Edit Coupon';
    document.getElementById('couponId').value = coupon.id;
    document.getElementById('code').value = coupon.code;
    document.getElementById('description').value = coupon.description || '';
    document.getElementById('maxUses').value = coupon.max_uses;
    document.getElementById('status').value = coupon.status;
    if (coupon.expires_at) {
        document.getElementById('expiresAt').value = new Date(coupon.expires_at).toISOString().slice(0, 16);
    }
    document.getElementById('couponModal').classList.remove('hidden');
}

function closeCouponModal() {
    document.getElementById('couponModal').classList.add('hidden');
    currentCoupon = null;
}

function openUsageModal(couponStr) {
    const coupon = JSON.parse(couponStr.replace(/&quot;/g, '"'));
    const usageDetails = document.getElementById('usageDetails');
    usageDetails.innerHTML = `
        <div class="bg-gray-50 p-4 rounded-lg">
            <p class="font-medium">Code: ${coupon.code}</p>
            <p>Total Uses: ${coupon.current_uses}/${coupon.max_uses}</p>
        </div>
        <div class="mt-4">
            <h4 class="font-medium mb-2">Usage History</h4>
            ${coupon.usage_details ? `
                <div class="space-y-2">
                    ${coupon.usage_details.map(usage => `
                        <div class="bg-white p-3 rounded border">
                            <p class="font-medium">${usage.name}</p>
                            <p class="text-sm text-gray-600">${usage.email}</p>
                            <p class="text-sm text-gray-500">
                                Used on: ${new Date(usage.used_at).toLocaleString()}
                            </p>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-gray-500">No usage history</p>'}
        </div>
    `;
    document.getElementById('usageModal').classList.remove('hidden');
}

function closeUsageModal() {
    document.getElementById('usageModal').classList.add('hidden');
}

function showDeleteConfirmation(id) {
    couponToDelete = id;
    document.getElementById('deleteConfirmationModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeDeleteModal() {
    document.getElementById('deleteConfirmationModal').classList.add('hidden');
    document.body.style.overflow = '';
    couponToDelete = null;
}

async function deleteCoupon(id) {
    if (!confirm('Are you sure you want to delete this coupon?')) return;
    
    try {
        const response = await fetch(`/admin/coupons/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            toast.show({
                type: 'error',
                title: 'Error',
                message: data.error || 'Failed to delete coupon'
            });
        }
    } catch (error) {
        console.error('Error:', error);
        toast.show({
            type: 'error',
            title: 'Error',
            message: 'Failed to delete coupon'
        });
    }
}

document.getElementById('couponForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        code: document.getElementById('code').value,
        description: document.getElementById('description').value,
        maxUses: document.getElementById('maxUses').value,
        status: document.getElementById('status').value,
        expiresAt: document.getElementById('expiresAt').value || null
    };

    const couponId = document.getElementById('couponId').value;
    const method = couponId ? 'PUT' : 'POST';
    const url = couponId ? `/admin/coupons/${couponId}` : '/admin/coupons';

    try {
        const response = await fetch(url, {
            method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            toast.show({
                type: 'error',
                title: 'Error',
                message: data.error || 'Failed to save coupon'
            });
        }
    } catch (error) {
        console.error('Error:', error);
        toast.show({
            type: 'error',
            title: 'Error',
            message: 'Failed to save coupon'
        });
    }
});

document.getElementById('filterForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const params = new URLSearchParams(formData);
    window.location.href = `/admin/coupons?${params.toString()}`;
});

document.getElementById('confirmDeleteButton').addEventListener('click', async () => {
    if (couponToDelete) {
        try {
            const response = await fetch(`/admin/coupons/${couponToDelete}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                closeDeleteModal();
                window.location.reload();
            } else {
                const data = await response.json();
                throw new Error(data.error || 'Failed to delete coupon');
            }
        } catch (error) {
            console.error('Error:', error);
            toast.show({
                type: 'error',
                title: 'Error',
                message: error.message || 'Failed to delete coupon'
            });
        }
    }
});
</script>

<%- include('../partials/admin-footer') %> 